#cloud-config
package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose

bootcmd:
  - mkdir -p /monitoring

write_files:
  - path: /monitoring/docker-compose.yml
    content: |
      volumes:
        victoria_metrics_data: {}
        prometheus_data: {}
        grafana_data: {}

      networks:
        monitoring:
          driver: bridge

      services:
        victoria-metrics:
          image: victoriametrics/victoria-metrics:latest
          ports:
            - "8428:8428"
          volumes:
            - victoria_metrics_data:/victoria-metrics
          restart: unless-stopped

        prometheus:
          image: prom/prometheus:latest
          container_name: prometheus
          volumes:
            - ./prometheus.yml:/etc/prometheus/prometheus.yml
            - prometheus_data:/prometheus
          command:
            - '--config.file=/etc/prometheus/prometheus.yml'
          ports:
            - "9090:9090"
          networks:
            - monitoring
          restart: unless-stopped

        node-exporter:
          image: prom/node-exporter:latest
          container_name: node-exporter
          ports:
            - "9100:9100"
          networks:
            - monitoring
          restart: unless-stopped

        grafana:
          image: grafana/grafana:latest
          container_name: grafana
          volumes:
            - grafana_data:/var/lib/grafana
          environment:
            - GF_SECURITY_ADMIN_USER=admin
            - GF_SECURITY_ADMIN_PASSWORD=admin
            - GF_USERS_ALLOW_SIGN_UP=false
          ports:
            - "3000:3000"
          networks:
            - monitoring
          restart: unless-stopped

  - path: /monitoring/prometheus.yml
    content: |
      global:
        scrape_interval: 15s
        evaluation_interval: 15s

      scrape_configs:
        - job_name: 'node-exporter'
          static_configs:
            - targets: ['node-exporter:9100']
        - job_name: 'victoria-metrics'
          static_configs:
            - targets: ['victoria-metrics:8428']

      remote_write:
        - url: http://victoria-metrics:8428/api/v1/write

runcmd:
  - systemctl enable docker
  - systemctl start docker
  - cd /monitoring
  - docker-compose up -d

